// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

/// Enums

enum UserRole {
  USER
  GUIDE
  ADMIN
}

enum BookingStatus {
  PENDING
  ACCEPTED
  REJECTED
  COMPLETED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
}

/// Models
model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  username  String   @unique
  fullname  String?
  password  String
  role      UserRole @default(USER)
  image     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isBanned  Boolean  @default(false)

  // Optional one-to-one relation for guide profile
  guide Guide?

  // Relations for bookings and reviews
  bookingsAsCustomer Booking[] @relation("CustomerBookings")
  bookingsAsGuide    Booking[] @relation("GuideBookings")
  reviewsAsCustomer  Review[]  @relation("CustomerReviews")
  reviewsAsGuide     Review[]  @relation("GuideReviews")
}

model Guide {
  id                    String                  @id @map("_id") @db.ObjectId
  bio                   String?
  tagline               String?
  location              LocationType?
  dailyRate             Float?
  expertises            String[]                @default([])
  languages             String[]
  experiences           GuideExperience[]
  certifications        CertificationType[]
  verification          GuideVerificationType?
  verificationDocuments VerificationDocuments[]

  // Establish relation with User via the same ID
  user     User      @relation(fields: [id], references: [id])
  packages Package[] @relation("GuidePackages")
}

enum VerificationDocumentType {
  PASSPORT
  LICENSE
}

model VerificationDocuments {
  id        String                   @id @map("_id") @db.ObjectId
  type      VerificationDocumentType
  fileUrl   String
  createdAt DateTime                 @default(now())
  updatedAt DateTime                 @updatedAt
  Guide     Guide?                   @relation(fields: [guideId], references: [id])
  guideId   String?                  @db.ObjectId
}

type GuideVerificationType {
  status  VerificationStatus?
  remarks String?
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

type LanguageType {
  name String
  code String
  id   String
}

type LocationType {
  country  String
  state    String
  county   String
  city     String
  geometry Json
}

type CertificationType {
  name       String
  issuer     String
  issuedDate DateTime
  expiryDate DateTime?
}

type GuideExperience {
  title       String
  company     String?
  location    String
  startDate   DateTime
  endDate     DateTime?
  description String
  expertises  String[]
}

// READ ONLY MODELS (NO UPDATE FROM FE, NO REFERENCES) -------------------
model Language {
  id   String @id @map("_id") @db.ObjectId
  name String
  code String
}

model Expertise {
  id         String   @id @map("_id") @db.ObjectId
  category   String
  expertises String[]
}

// ----------------------------------------------------------------------

enum VerificationCodeType {
  SIGNIN
  FORGOT_PASSWORD
}

model VerificationCode {
  id         String               @id @default(auto()) @map("_id") @db.ObjectId
  otp        String
  identifier String
  expires    DateTime             @db.Timestamp
  type       VerificationCodeType

  @@unique([otp, identifier])
}

model Booking {
  id             String        @id @default(auto()) @map("_id") @db.ObjectId
  customerId     String        @db.ObjectId
  guideId        String        @db.ObjectId
  startDate      DateTime
  endDate        DateTime
  bookingDate    DateTime      @default(now())
  status         BookingStatus @default(PENDING)
  totalAmount    Float?
  numberOfPeople Int
  destination    String
  message        String?

  // Relations to User for customer and guide
  customer User @relation("CustomerBookings", fields: [customerId], references: [id])
  guide    User @relation("GuideBookings", fields: [guideId], references: [id])

  // A booking can have one or more reviews
  reviews Review[]
  Payment Payment[]
}

model Payment {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  bookingId     String        @db.ObjectId
  amount        Float
  paymentDate   DateTime      @default(now())
  paymentMethod String?
  status        PaymentStatus @default(PENDING)
  transactionId String?

  // Relation to the associated booking
  booking Booking @relation(fields: [bookingId], references: [id])
}

model Review {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  bookingId  String   @db.ObjectId
  guideId    String   @db.ObjectId
  customerId String   @db.ObjectId
  rating     Int
  comment    String?
  reviewDate DateTime @default(now())

  // Relations
  booking  Booking @relation(fields: [bookingId], references: [id])
  guide    User    @relation("GuideReviews", fields: [guideId], references: [id])
  customer User    @relation("CustomerReviews", fields: [customerId], references: [id])
}

model Package {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String
  currency    String   @default("USD")
  price       Float
  duration    Int
  location    String
  guideId     String   @db.ObjectId
  guide       Guide    @relation("GuidePackages", fields: [guideId], references: [id])
  image       String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([name, guideId])
  @@unique([location, guideId])
}
